#!/system/bin/sh
set -e

# Paths
BOOT_PARTITION="/dev/block/by-name/boot"
TEMP_DIR="/tmp"
OLD_BOOT_IMG="${TEMP_DIR}/old-boot.img"
NEW_BOOT_IMG="${TEMP_DIR}/new-boot.img"
UNPACKED_BOOT_DIR="${TEMP_DIR}/unpacked_boot"

# Cleanup function to remove temporary files
cleanup() {
  rm -rf "${UNPACKED_BOOT_DIR}"
}
trap cleanup EXIT

echo "Disabling stock recovery restoration..."
dd if="${BOOT_PARTITION}" of="${OLD_BOOT_IMG}"
mkdir -p "${UNPACKED_BOOT_DIR}"
cd "${UNPACKED_BOOT_DIR}"
magiskboot unpack -h "${OLD_BOOT_IMG}"
magiskboot repack "${OLD_BOOT_IMG}" "${NEW_BOOT_IMG}"
cd -
dd if="${NEW_BOOT_IMG}" of="${BOOT_PARTITION}"
echo "Stock recovery restoration disabled."
